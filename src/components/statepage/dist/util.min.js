"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var NAME_SPACE="https://developers.google.com/blockly/xml",SOUP="!#$%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",Util={isDefined:function(t){return!(""===t||null==t)},createEl:function(t,e){var r=document.createElementNS(NAME_SPACE,t);if("object"===_typeof(e))for(var n in e)r.setAttribute(n,e[n]);return r},createFieldDom:function(t){var e=this.createEl("field");return e.setAttribute("name",t.name),t.id&&e.setAttribute("id",t.id),e.textContent=t.value,e},createCommentDom:function(t){var e=this.createEl("comment");return e.setAttribute("pinned",t.pinned||!1),e.textContent=t.value,e},createStateDefBlock:function(t,e){var r=this.createEl("value");r.setAttribute("name","ADD"+e);var n=this.createEl("block");n.setAttribute("type","state_def"),n.setAttribute("id",t.stateId);var i=this.createFieldDom({name:"NAME",value:t.name});return n.appendChild(i),r.appendChild(n),r},createNextStatesDom:function(t,a){var e,o,l=this;if(t.outputAry.length){if(e=this.createEl("next"),(o=this.createEl("block")).setAttribute("type","controls_if"),1<t.outputAry.length){var r=this.createEl("mutation");r.setAttribute("elseif",t.outputAry.length-1),o.appendChild(r)}t.outputAry.forEach(function(e,t){var r;(r=l.createEl("statement")).setAttribute("name","DO".concat(t)),r.setAttribute("id","".concat(e.lineId));var n=a.lineAry.find(function(t){return t.lineId===e.lineId});if(n){var i=a.stateAry.find(function(t){return t.stateId===n.endState.stateId});i?r.appendChild(Util.state2dom(i,a)):console.error("data error -^- ")}r&&o.appendChild(r)}),e.appendChild(o)}return e},createNextStatesDom2:function(l,d){var u,s,c,p=this;l.outputAry.length&&l.outputAry.forEach(function(e,t){var r,n=p.createEl("next");s=s||n,(u=p.createEl("block")).setAttribute("type","state_trigger_event"),u.setAttribute("id",e.lineId),u.setAttribute("start_state",JSON.stringify(l)),(r=p.createEl("statement")).setAttribute("name","DO0");var i=d.lineAry.find(function(t){return t.lineId===e.lineId});if(i){if(u.setAttribute("d",i.d),i.desc){var a=p.createCommentDom({value:i.desc});u.appendChild(a)}var o=d.stateAry.find(function(t){return t.stateId===i.endState.stateId});o?(u.setAttribute("end_state",JSON.stringify(o)),r.appendChild(Util.state2dom(o,d))):console.error("data error -^- ")}r&&u.appendChild(r),n.appendChild(u),c&&c.appendChild(n),c=u});return s},genBlockType:function(t){var e="state_opr";return"loopDiv"===t&&(e="controls_whileUntil"),e},saveStateXY:function(t,e){t.setAttribute("sx",e.x),t.setAttribute("sy",e.y)},saveStateBlockDataInDom:function(t,e){switch(e.stateType){case"stateDiv":this.saveStateXY(t,e);break;case"state_trigger_event":this.saveLineData(t,e)}},saveLineData:function(t,e){t.setAttribute("d",e.d),t.setAttribute("start_state",JSON.stringify(e.startState)),t.setAttribute("end_state",JSON.stringify(e.startState))},state2dom:function(t,e){var r=this.createEl("block");console.log(t.stateId+" --- "+t.name+" --- "+t.stateType),r.setAttribute("id",t.stateId),r.setAttribute("type",this.genBlockType(t.stateType)),this.saveStateBlockDataInDom(r,t);var n=this.createFieldDom({id:t.stateId,name:"field_state",value:t.name});r.appendChild(n);var i=this.createFieldDom({id:t.stateId,name:"SX_FIELD",value:8888});r.appendChild(i);var a=this.createNextStatesDom2(t,e);return a&&r.appendChild(a),r},createThreadDefDom:function(t,e){var r=this.createEl("block",{type:"thread_def"}),n=this.createEl("field",{name:"NAME",textContent:t.name});n.textContent=t.name;var i=this.createEl("statement",{name:"CALLBACK"}),a=this.createEl("block",{type:"procedure_select"}),o=this.createEl("field",{name:"field_procedure",id:e});return o.textContent=t.name+"_function",a.appendChild(o),i.appendChild(a),r.appendChild(n),r.appendChild(i),r},createThreadProcedureDom:function(t,e,r){console.log("---thread.name---"+t.name);var n=this.createEl("block",{type:"procedures_defnoreturn",id:e}),i=this.createEl("field",{name:"NAME"});i.textContent=t.name+"_function";var a=this.createEl("statement",{name:"STACK"});return a.appendChild(r),n.appendChild(i),n.appendChild(a),n},genUid:function(){for(var t=SOUP.length,e=[],r=0;r<20;r++)e[r]=SOUP.charAt(Math.random()*t);return e.join("")},getDomChildren:function(t){var e=[];return t.children&&(e=Array.prototype.slice.call(t.children)),e},getStateXY:function(t,e){var r=t.getAttribute("sx"),n=t.getAttribute("sy");function i(t){var e=t.parent;if(e){if("state_trigger_event"===e.type)return e;e=i(e)}return e}var a=i(t)&&i(t).getAttribute("id");if(!r||"undefined"===r){var o=function t(e){var r=e.parent;if(r){if("state_opr"===r.type)return r;r=t(r)}return r}(t);if(!o)return{x:0,y:0};var l=o.getAttribute("sx"),d=o.getAttribute("sy");l&&"undefined"!==l||(d=l=0),r=l+150;var u=0;e.find(function(t){return t.stateId===o.getAttribute("id")}).outputAry.forEach(function(t,e){if(t.lineId===a)return u=e,!1}),n=d+100*u}return{x:r,y:n}},state2blockly:function(t){var e=t,u=Util.createEl("xml");return u.setAttribute("xmlns","https://developers.google.com/blockly/xml"),e.forEach(function(t,e){var r=t.stateAry[0],n=Util.createEl("block");n.setAttribute("type","lists_state"),n.setAttribute("x",300+700*e),n.setAttribute("y",150);var i=Util.createEl("mutation");i.setAttribute("items",t.stateAry.length),n.appendChild(i),t.stateAry.forEach(function(t,e){var r=Util.createStateDefBlock(t,e);n.appendChild(r)});var a=Util.state2dom(r,t),o=Util.genUid(),l=Util.createThreadDefDom(t,o),d=Util.createThreadProcedureDom(t,o,a);Util.isDefined(t.x)?l.setAttribute("x",t.x):l.setAttribute("x",700*e),Util.isDefined(t.y)?l.setAttribute("y",t.y):l.setAttribute("y",10),d.setAttribute("x",700*e),d.setAttribute("y",200),u.appendChild(n),u.appendChild(d),u.appendChild(l)}),u.outerHTML},blockly2state:function(t){"string"==typeof t&&(t=(new DOMParser).parseFromString(t,"text/xml"));var i="state_opr",a=[],l=[];return function t(e){if("block"===e.tagName&&e.getAttribute("type")===i){var o=function(t){return{stateId:t.getAttribute("id"),stateType:i}},r={stateId:e.getAttribute("id"),stateType:e.getAttribute("type")===i?"stateDiv":"loopDiv",bx:parseInt(e.getAttribute("x"),10),by:parseInt(e.getAttribute("y"),10),x:Util.getStateXY(e).x,y:Util.getStateXY(e).y,width:"76px",height:"40px",name:e.children[0].textContent,inputAry:[],outputAry:[],children:[],nodeHeight:0};!function n(i,a){return Util.getDomChildren(i).forEach(function(t){if("next"===t.tagName&&t.children&&t.children[0]&&"state_trigger_event"===t.children[0].getAttribute("type")){var e=t.children[0],r={lineId:e.getAttribute("id"),d:e.getAttribute("d"),startState:o(i),endState:o(e.children[0].children[0])};a.find(function(t){return t.lineId===e.getAttribute("id")})||a.push(r),l.find(function(t){return t.lineId===e.getAttribute("id")})||l.push(r),n(e.children[0].children[0],a)}}),a}(e,r.outputAry),function(t,e){var r=t.parent&&t.parent.parent;if(r&&"state_trigger_event"===r.getAttribute("type")){var n={lineId:lineDom.getAttribute("id"),d:lineDom.getAttribute("d"),startState:o(r),endState:o(t)};e.find(function(t){return t.lineId===n.lineId})||e.push(n),l.find(function(t){return t.lineId===n.lineId})||l.push(n)}}(e,r.inputAry),a.find(function(t){return t.stateId===r.stateId})||a.push(r)}if(e.children&&e.children.length)for(var n=0;n<e.children.length;n++)t(e.children[n])}(t),{stateAry:a,lineAry:l}},copyBlocklyXml2Clipboard:function(t){var e=document.createElement("input");e.setAttribute("type","text"),e.setAttribute("value",t),e.setAttribute("style","height: 0; overflow: hidden;"),document.body.appendChild(e),e.focus(),e.select(),document.execCommand("copy"),document.body.removeChild(e)},workspace2dom:function(){var t="",e=document.getElementById("blocklyIframe");if(e){var r=e.contentWindow,n=r.Blockly.Xml.workspaceToDom(r.Code.workspace);t=r.Blockly.Xml.domToPrettyText(n)}else console.error("当前页面没有嵌入blockly");return t}},_default=Util;exports.default=_default;
//# sourceMappingURL=util.min.js.map
