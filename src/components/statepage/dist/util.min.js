"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _dagre=_interopRequireDefault(require("dagre")),_qblock=_interopRequireDefault(require("./qblock.js")),_graphCfg=require("./graphCfg.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var NAME_SPACE="https://developers.google.com/blockly/xml",SOUP="!#$%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",RANKSEP=_graphCfg.lineCfg.rankSep,Util={isDefined:function(t){return!(""===t||null==t)},createEl:function(t,e){var r=document.createElementNS(NAME_SPACE,t);if("object"===_typeof(e))for(var n in e)r.setAttribute(n,e[n]);return r},createFieldDom:function(t){var e=this.createEl("field");return e.setAttribute("name",t.name),t.id&&e.setAttribute("id",t.id),e.textContent=t.value,e},createCommentDom:function(t){var e=this.createEl("comment");return e.setAttribute("pinned",t.pinned||!1),e.textContent=t.value,e},createStateDefBlock:function(t,e,r){var n=this.createEl("value");n.setAttribute("name","ADD"+e);var i=this.createEl("block");i.setAttribute("type","state_def"),i.setAttribute("id",t.stateId);var a=this.createFieldDom({name:"NAME",value:t.name});if(i.appendChild(a),t.children&&t.children.length){var o=t.children.find(function(t){return!t.inputAry||0===t.inputAry.length}),l=Util.state2dom(o,r),d=this.createEl("statement");d.setAttribute("name","STACK"),d.appendChild(l),i.appendChild(d)}return n.appendChild(i),n},createNextStatesDom:function(t,a){var e,o,l=this;if(t.outputAry.length){if(e=this.createEl("next"),(o=this.createEl("block")).setAttribute("type","controls_if"),1<t.outputAry.length){var r=this.createEl("mutation");r.setAttribute("elseif",t.outputAry.length-1),o.appendChild(r)}t.outputAry.forEach(function(e,t){var r;(r=l.createEl("statement")).setAttribute("name","DO".concat(t)),r.setAttribute("id","".concat(e.lineId));var n=a.lineAry.find(function(t){return t.lineId===e.lineId});if(n){var i=store.getStateImplement(n.endState.stateId,a.stateAry);i?r.appendChild(Util.state2dom(i,a)):console.error("data error -^- ")}r&&o.appendChild(r)}),e.appendChild(o)}return e},createNextStatesDom2:function(t,l){var d,u,s,c=this;t.outputAry.length&&t.outputAry.forEach(function(e,t){var r,n=c.createEl("next");u=u||n,(d=c.createEl("block")).setAttribute("type","state_trigger_event"),d.setAttribute("id",e.lineId),e.lineId.indexOf("line"),(r=c.createEl("statement")).setAttribute("name","DO0");var i=l.lineAry.find(function(t){return t.lineId===e.lineId});if(i){if(Util.saveLineData(d,i),i.desc){var a=c.createCommentDom({value:i.desc});d.appendChild(a)}var o=store.getStateImplement(i.endState.stateId,l.stateAry);o?r.appendChild(Util.state2dom(o,l)):console.error("data error -^- ")}r&&d.appendChild(r),n.appendChild(d),s&&s.appendChild(n),s=d});return u},genBlockType:function(t){var e="state_opr";return"loopDiv"===t&&(e="controls_whileUntil"),e},saveStateXY:function(t,e){t.setAttribute("sx",e.x),t.setAttribute("sy",e.y)},saveStateWidthHeight:function(t,e){t.setAttribute("s_width",e.width),t.setAttribute("s_height",e.height)},saveStateMode:function(t,e){t.setAttribute("mode",e.mode)},saveStateBlockDataInDom:function(t,e){switch(console.log(e),e.stateType){case"stateDiv":this.saveStateXY(t,e),this.saveStateWidthHeight(t,e),this.saveStateMode(t,e)}},saveLineData:function(t,e){t.setAttribute("s_type",e.type)},state2dom:function(t,e){var r=this.createEl("block");r.setAttribute("type",this.genBlockType(t.stateType)),this.saveStateBlockDataInDom(r,t);var n=this.createFieldDom({id:t.stateId,name:"field_state",value:t.name});r.appendChild(n);var i=this.createNextStatesDom2(t,e);return i&&r.appendChild(i),r},createThreadDefDom:function(t,e){var r=this.createEl("block",{type:"thread_def"}),n=this.createEl("field",{name:"NAME",textContent:t.name});n.textContent=t.name;var i=this.createEl("statement",{name:"CALLBACK"}),a=this.createEl("block",{type:"procedure_select"}),o=this.createEl("field",{name:"field_procedure",id:e});return o.textContent=t.name+"_function",a.appendChild(o),i.appendChild(a),r.appendChild(n),r.appendChild(i),r},createThreadProcedureDom:function(t,e,r){console.log("---thread.name---"+t.name);var n=this.createEl("block",{type:"procedures_defnoreturn",id:e}),i=this.createEl("field",{name:"NAME"});i.textContent=t.name+"_function";var a=this.createEl("statement",{name:"STACK"});return a.appendChild(r),n.appendChild(i),n.appendChild(a),n},genUid:function(){for(var t=SOUP.length,e=[],r=0;r<20;r++)e[r]=SOUP.charAt(Math.random()*t);return e.join("")},getDomChildren:function(t){var e=[];return t.children&&(e=Array.prototype.slice.call(t.children)),e},toNum:function(t){return parseInt(t,10)},translatePX2Num:function(t){return/px/.test(t)&&(t=t.replace("px","")),+t},getPrevStateDom:function(t){var e=t.parentNode;if(e){if("state_opr"===e.getAttribute("type"))return e;e=this.getPrevStateDom(e)}return e},getStateXY:function(t,e){var r=this.toNum(t.getAttribute("sx")),n=this.toNum(t.getAttribute("sy"));function i(t){var e=t.parentNode;if(e){if(e.getAttribute&&"state_trigger_event"===e.getAttribute("type"))return e;e=i(e)}return e}var a=i(t)&&i(t).getAttribute("id");if(!r||"undefined"===r){var o=Util.getPrevStateDom(t);if(!o)return{x:0,y:0};var l=this.toNum(o.getAttribute("sx")),d=this.toNum(o.getAttribute("sy"));l&&"undefined"!==l||(d=l=0),r=l+150;var u=0;e.find(function(t){return t.stateId===Util.getEntityStateId(o)}).outputAry.forEach(function(t,e){if(t.lineId===a)return u=e,!1}),n=d+100*u}return{x:r,y:n}},getEntityStateId:function(t){return t.children[0].getAttribute("id")},state2blockly:function(t){var e=t,u=Util.createEl("xml");return u.setAttribute("xmlns","https://developers.google.com/blockly/xml"),e.forEach(function(n,t){var e=n.stateAry[0],i=Util.createEl("block");i.setAttribute("type","lists_state"),i.setAttribute("x",300+700*t),i.setAttribute("y",150);var r=Util.createEl("mutation");r.setAttribute("items",n.stateAry.length),i.appendChild(r),n.stateAry.forEach(function(t,e){var r=Util.createStateDefBlock(t,e,n);i.appendChild(r)});var a=Util.state2dom(e,n),o=Util.genUid(),l=Util.createThreadDefDom(n,o),d=Util.createThreadProcedureDom(n,o,a);Util.isDefined(n.x)?l.setAttribute("x",n.x):l.setAttribute("x",700*t),Util.isDefined(n.y)?l.setAttribute("y",n.y):l.setAttribute("y",10),d.setAttribute("x",700*t),d.setAttribute("y",200),u.appendChild(i),u.appendChild(d),u.appendChild(l)}),u.outerHTML},blockly2state:function(t){"string"==typeof t&&(t=(new DOMParser).parseFromString(t,"text/xml"));var e=Util.getProceduresDefDom(t),r=Util.getListStateDom(t),n=[],i=[];return Util.extractStateAndLine(e,n,i),Util.updateChildrenOfState(n,r,i),{stateAry:n,lineAry:i}},extractStateAndLine:function(t,e,a){var r="state_opr";if(t&&"block"===t.tagName&&t.getAttribute("type")===r){var o=function(t){var e=t.getAttribute("id");return t.getAttribute("type")===r&&(e=Util.getEntityStateId(t)),{stateId:e,stateType:r}},n=Util.getEntityStateId(t),i=e.find(function(t){return t.stateId===n});i=i||{stateId:Util.getEntityStateId(t),stateType:t.getAttribute("type")===r?"stateDiv":"loopDiv",bx:parseInt(t.getAttribute("x"),10),by:parseInt(t.getAttribute("y"),10),x:Util.getStateXY(t,e).x,y:Util.getStateXY(t,e).y,width:t.getAttribute("s_width")||"76px",height:t.getAttribute("s_height")||"40px",name:t.children[0].textContent,mode:t.getAttribute("mode")||"default",inputAry:[],outputAry:[],children:[],parent:null,nodeHeight:0},function n(t,i){return Util.getDomChildren(t).forEach(function(t){if("next"===t.tagName&&t.children&&t.children[0]&&"state_trigger_event"===t.children[0].getAttribute("type")){var e=t.children[0];e.getAttribute("id").indexOf("line");var r={lineId:e.getAttribute("id"),d:e.getAttribute("d"),type:e.getAttribute("s_type"),startState:o(Util.getStartStateDomOfLine(e)),endState:o(Util.getEndStateDomOfLine(e))};r.lineId.indexOf("line"),i.find(function(t){return t.lineId===e.getAttribute("id")})||i.push(r),a.find(function(t){return t.lineId===e.getAttribute("id")||t.startState.stateId===r.startState.stateId&&t.endState.stateId===r.endState.stateId})||a.push(r),n(e,i)}}),i}(t,i.outputAry),function(t,e){var r=t.parentNode&&t.parentNode.parentNode;if(r&&"state_trigger_event"===r.getAttribute("type")){var n={lineId:r.getAttribute("id"),d:r.getAttribute("d"),type:r.getAttribute("s_type"),startState:o(Util.getPrevStateDom(r)),endState:o(Util.getEndStateDomOfLine(r))};n.lineId.indexOf("line"),e.find(function(t){return t.lineId===n.lineId})||e.push(n),a.find(function(t){return t.lineId===r.getAttribute("id")||t.startState.stateId===n.startState.stateId&&t.endState.stateId===n.endState.stateId})||a.push(n)}}(t,i.inputAry),e.find(function(t){return t.stateId===i.stateId})||e.push(i)}if(t&&t.children&&t.children.length)for(var l=0;l<t.children.length;l++){var d=t.children[l];Util.extractStateAndLine(d,e,a)}},updateChildrenOfState:function(e,t,r){if(t&&"block"===t.tagName&&"state_def"===t.getAttribute("type")){if(t.childNodes){var n=Array.prototype.slice.call(t.childNodes).find(function(t){return"statement"===t.tagName});if(n){var i=[],a=(Util.extractStateAndLine(n,i,r),Util.getStateById(e,t.getAttribute("id")));a&&(a.children=i).forEach(function(t){t.parent=a.stateId})}}}else t&&Array.prototype.slice.call(t.childNodes).forEach(function(t){Util.updateChildrenOfState(e,t,r)})},getProceduresDefDom:function(t){var e;if("block"===t.tagName&&"procedures_defnoreturn"===t.getAttribute("type"))e=t;else for(var r=Array.prototype.slice.call(t.childNodes),n=0;n<r.length&&!(e=Util.getProceduresDefDom(r[n]));n++);return e},getListStateDom:function(t){var e;if(t&&t.tagName&&"block"===t.tagName&&"lists_state"===t.getAttribute("type"))e=t;else for(var r=Array.prototype.slice.call(t.childNodes),n=0;n<r.length&&!(e=Util.getListStateDom(r[n]));n++);return e},getStateById:function(t,e){for(var r,n,i=0;i<t.length;i++){if((r=t[i]).stateId===e)return r;r.children&&r.children.length&&(n=Util.getStateById(r.children,e))}return n},getStartStateDomOfLine:function(t){return this.getPrevStateDom(t)},getEndStateDomOfLine:function(t){var e=Array.prototype.slice.call(t.childNodes).find(function(t){return"statement"===t.nodeName}),r=Array.prototype.slice.call(e.childNodes).find(function(t){return"block"===t.nodeName});return r||console.error("数据错误：触发事件连线没有连接正确的状态"),r},copyBlocklyXml2Clipboard:function(t){var e=document.createElement("input");e.setAttribute("type","text"),e.setAttribute("value",t),e.setAttribute("style","height: 0; overflow: hidden;"),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)},workspace2dom:function(){var t="",e=document.getElementById("blocklyIframe");if(e){var r=e.contentWindow,n=r.Blockly.Xml.workspaceToDom(r.Code.workspace);t=r.Blockly.Xml.domToPrettyText(n)}else console.error("当前页面没有嵌入blockly");return t},resetAllStateData:function(t){t&&t.stateAry.forEach(function(t){t.x=0,t.y=0})},autoLayout:function(t){if(t){Util.findFirstState(t.stateAry);t.stateAry.forEach(function(t){t.virtualHeight=Util.getVirtualHeight(t),t.y=(void 0).y+(void 0).virtualHeight})}},findFirstState:function(t){return t[0]},getVirtualHeight:function(t){var n=[];t.outputAry.forEach(function(e){var r=thread.lineAry.find(function(t){return t.lineId===e.lineId}),t=thread.stateAry.find(function(t){return t.stateId===r.endState.stateId});n.push(t)});var e=0;return n.forEach(function(t){t.virtualHeight||(t.virtualHeight=Util.getVirtualHeight(t),e+=t.virtualHeight)}),e},getAutoXY:function(t){if(t.y)return{x:t.x,y:t.y};t.y=prevState.y+prevState.virtualHeight},getDomByStateId:function(e){var t=document.getElementsByClassName("state-wrap");return Array.prototype.slice.call(t).find(function(t){return t.getAttribute("stateid")===e})},genGraphByLayer:function(i,t,a){var o=new _dagre.default.graphlib.Graph({});return o.setGraph({rankdir:"LR",align:"UL",edgesep:0,ranksep:RANKSEP}),o.setDefaultEdgeLabel(function(){return{}}),(t.stateAry?t.stateAry:t.children).forEach(function(n){o.setNode(n.stateId,{label:n.name,width:_qblock.default.State.getStateWidth(n),height:_qblock.default.State.getStateHeight(n)}),n.outputAry.forEach(function(e){var t=a.find(function(t){return t.lineId===e.lineId}),r=store.getState(i,t.endState.stateId);o.setEdge(n.stateId,r.stateId,{label:e.lineId})})}),o},setStateXYbyNode:function(t,e){var r=_qblock.default.State.getStateWidth(t)/2,n=_qblock.default.State.getStateHeight(t)/2;t.x=e.x-r+20,t.y=e.y-n+20},setStateXYbyLayer:function(n,i,t){t.stateAry?t.stateAry:t.children,i.nodes().forEach(function(t){var e=i.node(t),r=store.getState(n,t);r&&(Util.setStateXYbyNode(r,e),r.inputAry&&r.inputAry.length&&r.inputAry.forEach(function(t){store.stateData.lineMap[t.lineId].refresh()})),console.log("Node "+t+": "+JSON.stringify(i.node(t)))})},testLayout:function(t,e,r){var n=this.genGraphByLayer(t,e,r);_dagre.default.layout(n),this.setStateXYbyLayer(t,n,e)}},_default=Util;exports.default=_default;
//# sourceMappingURL=util.min.js.map
